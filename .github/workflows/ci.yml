name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  validate-skills:
    name: Validate Skills
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Find all SKILL.md files
        id: find-skills
        run: |
          SKILL_COUNT=$(find . -name "SKILL.md" -type f | wc -l)
          echo "Found $SKILL_COUNT SKILL.md files"
          echo "skill_count=$SKILL_COUNT" >> $GITHUB_OUTPUT

      - name: Validate SKILL.md frontmatter
        run: |
          echo "ðŸ” Validating SKILL.md files..."
          ERRORS=0

          for skill in $(find . -name "SKILL.md" -type f); do
            # Check frontmatter exists
            if ! head -1 "$skill" | grep -q "^---$"; then
              echo "âŒ Missing frontmatter: $skill"
              ERRORS=$((ERRORS + 1))
              continue
            fi

            # Extract frontmatter (lines between first --- and second ---)
            FRONTMATTER=$(sed -n '2,/^---$/p' "$skill")

            # Check name field in frontmatter only
            if ! echo "$FRONTMATTER" | grep -q "^name:"; then
              echo "âŒ Missing 'name' field in frontmatter: $skill"
              ERRORS=$((ERRORS + 1))
            fi

            # Check description field in frontmatter only
            if ! echo "$FRONTMATTER" | grep -q "^description:"; then
              echo "âŒ Missing 'description' field in frontmatter: $skill"
              ERRORS=$((ERRORS + 1))
            fi

            echo "âœ… $skill"
          done

          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          if [ $ERRORS -gt 0 ]; then
            echo "âŒ Validation failed with $ERRORS error(s)"
            exit 1
          else
            echo "âœ… All ${{ steps.find-skills.outputs.skill_count }} skills validated successfully"
          fi

      - name: Check for duplicate skill names
        run: |
          echo "ðŸ” Checking for duplicate skill names..."

          # Extract skill names from frontmatter only (between first --- and second ---)
          NAMES=""
          for skill in $(find . -name "SKILL.md" -type f); do
            # Extract frontmatter and get name field
            NAME=$(sed -n '2,/^---$/p' "$skill" | grep "^name:" | head -1 | cut -d: -f2 | tr -d ' ')
            if [ -n "$NAME" ]; then
              NAMES="$NAMES$NAME"$'\n'
            fi
          done

          DUPLICATES=$(echo "$NAMES" | sort | uniq -d)

          if [ -n "$DUPLICATES" ]; then
            echo "âŒ Duplicate skill names found:"
            echo "$DUPLICATES"
            exit 1
          else
            echo "âœ… No duplicate skill names"
          fi

  markdown-lint:
    name: Markdown Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install markdownlint-cli
        run: npm install -g markdownlint-cli

      - name: Create markdownlint config
        run: |
          cat > .markdownlint.json << 'EOF'
          {
            "default": true,
            "MD013": false,
            "MD033": false,
            "MD041": false,
            "MD024": false,
            "MD036": false,
            "MD040": false
          }
          EOF

      - name: Run markdownlint on SKILL.md files
        run: |
          find . -name "SKILL.md" -type f | xargs markdownlint || true
          echo "âš ï¸ Markdown lint completed (warnings only)"

  structure-check:
    name: Structure Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check required files exist
        run: |
          echo "ðŸ” Checking required files..."
          ERRORS=0

          # Check README.md
          if [ ! -f "README.md" ]; then
            echo "âŒ Missing README.md"
            ERRORS=$((ERRORS + 1))
          else
            echo "âœ… README.md exists"
          fi

          # Check LICENSE
          if [ ! -f "LICENSE" ]; then
            echo "âŒ Missing LICENSE"
            ERRORS=$((ERRORS + 1))
          else
            echo "âœ… LICENSE exists"
          fi

          # Check CONTRIBUTING.md
          if [ ! -f "CONTRIBUTING.md" ]; then
            echo "âŒ Missing CONTRIBUTING.md"
            ERRORS=$((ERRORS + 1))
          else
            echo "âœ… CONTRIBUTING.md exists"
          fi

          if [ $ERRORS -gt 0 ]; then
            echo "âŒ Structure check failed"
            exit 1
          else
            echo "âœ… All required files present"
          fi

      - name: Check category directories
        run: |
          echo "ðŸ” Checking category directories..."

          EXPECTED_DIRS="software-design software-engineering development-stacks tools-integrations domain-applications programming-languages"

          for dir in $EXPECTED_DIRS; do
            if [ -d "$dir" ]; then
              SKILL_COUNT=$(find "$dir" -name "SKILL.md" | wc -l)
              echo "âœ… $dir/ ($SKILL_COUNT skills)"
            else
              echo "âš ï¸ Missing directory: $dir/"
            fi
          done
