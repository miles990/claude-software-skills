# ============================================================================
# Auto Development Workflow
# ============================================================================
# è§¸ç™¼æ–¹å¼ï¼š
#   1. Issue åŠ ä¸Š "auto-dev" label
#   2. PR comment åŒ…å« "/evolve" å‘½ä»¤
#   3. æ‰‹å‹•è§¸ç™¼ (workflow_dispatch)
#
# æµç¨‹ï¼š
#   Issue/Command â†’ Claude Code + Evolve â†’ PR â†’ äººé¡å¯©æŸ¥ â†’ è¨˜æ†¶æ›´æ–°
# ============================================================================

name: ğŸ¤– Auto Development

on:
  # è§¸ç™¼é» 1: Issue æ¨™è¨˜
  issues:
    types: [labeled]

  # è§¸ç™¼é» 2: Issue/PR Comment å‘½ä»¤
  issue_comment:
    types: [created]

  # è§¸ç™¼é» 3: æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:
    inputs:
      goal:
        description: 'é–‹ç™¼ç›®æ¨™'
        required: true
        type: string
      priority:
        description: 'å„ªå…ˆç´š'
        required: false
        type: choice
        options:
          - normal
          - high
          - low
        default: normal
      max_iterations:
        description: 'æœ€å¤§è¿­ä»£æ¬¡æ•¸'
        required: false
        type: number
        default: 10

# ç¢ºä¿åŒæ™‚åªæœ‰ä¸€å€‹è‡ªå‹•é–‹ç™¼ä»»å‹™é‹è¡Œ
concurrency:
  group: auto-dev-${{ github.event.issue.number || github.run_id }}
  cancel-in-progress: false

env:
  ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
  NODE_ENV: production

jobs:
  # =========================================================================
  # Job 1: è§£æè§¸ç™¼æ¢ä»¶
  # =========================================================================
  parse-trigger:
    name: ğŸ“‹ Parse Trigger
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
      goal: ${{ steps.check.outputs.goal }}
      issue_number: ${{ steps.check.outputs.issue_number }}
      trigger_type: ${{ steps.check.outputs.trigger_type }}
      priority: ${{ steps.check.outputs.priority }}
      max_iterations: ${{ steps.check.outputs.max_iterations }}

    steps:
      - name: Check trigger conditions
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const event = context.eventName;
            let shouldRun = false;
            let goal = '';
            let issueNumber = null;
            let triggerType = '';
            let priority = 'normal';
            let maxIterations = 10;

            // Case 1: Issue labeled with "auto-dev"
            if (event === 'issues' && context.payload.action === 'labeled') {
              const label = context.payload.label.name;
              if (label === 'auto-dev' || label === 'ğŸ¤– auto-dev') {
                shouldRun = true;
                goal = context.payload.issue.title + '\n\n' + context.payload.issue.body;
                issueNumber = context.payload.issue.number;
                triggerType = 'issue_label';

                // æª¢æŸ¥æ˜¯å¦æœ‰å„ªå…ˆç´š label
                const labels = context.payload.issue.labels.map(l => l.name);
                if (labels.includes('priority:high')) priority = 'high';
                if (labels.includes('priority:low')) priority = 'low';
              }
            }

            // Case 2: Comment with /evolve command
            if (event === 'issue_comment' && context.payload.action === 'created') {
              const comment = context.payload.comment.body;
              const evolveMatch = comment.match(/^\/evolve\s+(.+)/s);

              if (evolveMatch) {
                shouldRun = true;
                goal = evolveMatch[1].trim();
                issueNumber = context.payload.issue.number;
                triggerType = 'comment_command';

                // è§£æå¯é¸åƒæ•¸
                const priorityMatch = comment.match(/--priority[=\s]+(\w+)/);
                if (priorityMatch) priority = priorityMatch[1];

                const iterMatch = comment.match(/--max-iterations[=\s]+(\d+)/);
                if (iterMatch) maxIterations = parseInt(iterMatch[1]);
              }
            }

            // Case 3: Manual dispatch
            if (event === 'workflow_dispatch') {
              shouldRun = true;
              goal = context.payload.inputs.goal;
              triggerType = 'manual';
              priority = context.payload.inputs.priority || 'normal';
              maxIterations = parseInt(context.payload.inputs.max_iterations) || 10;
            }

            core.setOutput('should_run', shouldRun);
            core.setOutput('goal', goal);
            core.setOutput('issue_number', issueNumber);
            core.setOutput('trigger_type', triggerType);
            core.setOutput('priority', priority);
            core.setOutput('max_iterations', maxIterations);

            console.log(`Trigger: ${triggerType}, Should Run: ${shouldRun}`);
            if (goal) console.log(`Goal: ${goal.substring(0, 100)}...`);

  # =========================================================================
  # Job 2: åŸ·è¡Œè‡ªå‹•é–‹ç™¼
  # =========================================================================
  evolve:
    name: ğŸ§¬ Evolve
    needs: parse-trigger
    if: needs.parse-trigger.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 60  # æœ€é•·åŸ·è¡Œ 1 å°æ™‚

    outputs:
      branch_name: ${{ steps.setup.outputs.branch_name }}
      has_changes: ${{ steps.check-changes.outputs.has_changes }}
      summary: ${{ steps.evolve.outputs.summary }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup environment
        id: setup
        run: |
          # ç”Ÿæˆåˆ†æ”¯åç¨±
          ISSUE_NUM="${{ needs.parse-trigger.outputs.issue_number }}"
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)

          if [ -n "$ISSUE_NUM" ]; then
            BRANCH_NAME="auto-dev/issue-${ISSUE_NUM}-${TIMESTAMP}"
          else
            BRANCH_NAME="auto-dev/manual-${TIMESTAMP}"
          fi

          echo "branch_name=${BRANCH_NAME}" >> $GITHUB_OUTPUT

          # å»ºç«‹ä¸¦åˆ‡æ›åˆ†æ”¯
          git checkout -b "$BRANCH_NAME"

          # è¨­å®š Git ç”¨æˆ¶
          git config user.name "Auto-Dev Bot"
          git config user.email "auto-dev-bot@users.noreply.github.com"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code
        run: |
          npm install -g @anthropic-ai/claude-code

      - name: Initialize memory system
        run: |
          # ç¢ºä¿è¨˜æ†¶ç›®éŒ„å­˜åœ¨
          mkdir -p .claude/memory/{learnings,failures,decisions,patterns,strategies}

          # åˆå§‹åŒ– index.mdï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
          if [ ! -f .claude/memory/index.md ]; then
            cat > .claude/memory/index.md << 'EOF'
          # å°ˆæ¡ˆè¨˜æ†¶ç´¢å¼•

          > è‡ªå‹•ç¶­è­·ï¼Œè«‹å‹¿æ‰‹å‹•ç·¨è¼¯ä¸»è¦å€å¡Š

          ## æœ€è¿‘å­¸ç¿’
          <!-- LEARNINGS_START -->
          <!-- LEARNINGS_END -->

          ## é‡è¦æ±ºç­–
          <!-- DECISIONS_START -->
          <!-- DECISIONS_END -->

          ## å¤±æ•—ç¶“é©—
          <!-- FAILURES_START -->
          <!-- FAILURES_END -->

          ## æ¨ç†æ¨¡å¼
          <!-- PATTERNS_START -->
          <!-- PATTERNS_END -->

          ## æ¨™ç±¤ç´¢å¼•
          <!-- TAGS_START -->
          <!-- TAGS_END -->
          EOF
          fi

      - name: Post start notification
        if: needs.parse-trigger.outputs.issue_number
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ needs.parse-trigger.outputs.issue_number }};
            const branchName = '${{ steps.setup.outputs.branch_name }}';
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `## ğŸ¤– Auto-Dev é–‹å§‹åŸ·è¡Œ

            | é …ç›® | å€¼ |
            |------|-----|
            | åˆ†æ”¯ | \`${branchName}\` |
            | å„ªå…ˆç´š | ${{ needs.parse-trigger.outputs.priority }} |
            | æœ€å¤§è¿­ä»£ | ${{ needs.parse-trigger.outputs.max_iterations }} |
            | åŸ·è¡Œç´€éŒ„ | [æŸ¥çœ‹ Action](${runUrl}) |

            â³ åŸ·è¡Œä¸­ï¼Œå®Œæˆå¾Œæœƒè‡ªå‹•å»ºç«‹ PR...`
            });

      - name: Run Claude Code with Evolve
        id: evolve
        env:
          GOAL: ${{ needs.parse-trigger.outputs.goal }}
          MAX_ITERATIONS: ${{ needs.parse-trigger.outputs.max_iterations }}
          ISSUE_NUMBER: ${{ needs.parse-trigger.outputs.issue_number }}
        run: |
          # å»ºç«‹åŸ·è¡Œç´€éŒ„
          EXECUTION_LOG=".claude/memory/executions/$(date +%Y%m%d-%H%M%S).md"
          mkdir -p .claude/memory/executions

          # åŸ·è¡Œ Claude Code
          # --dangerously-skip-permissions: CI ç’°å¢ƒéœ€è¦
          # --max-turns: é™åˆ¶å°è©±è¼ªæ•¸
          # --output-format: çµæ§‹åŒ–è¼¸å‡º
          claude --dangerously-skip-permissions \
                 --max-turns 50 \
                 --output-format json \
                 "/evolve $GOAL" 2>&1 | tee execution.log

          # æå–åŸ·è¡Œæ‘˜è¦
          SUMMARY=$(tail -50 execution.log | head -20)
          echo "summary<<EOF" >> $GITHUB_OUTPUT
          echo "$SUMMARY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Check for changes
        id: check-changes
        run: |
          git add -A

          if git diff --cached --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected:"
            git diff --cached --stat
          fi

      - name: Commit changes
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          ISSUE_NUM="${{ needs.parse-trigger.outputs.issue_number }}"

          # Commit message
          if [ -n "$ISSUE_NUM" ]; then
            COMMIT_MSG="feat: Auto-dev for issue #${ISSUE_NUM}

          Goal: $(echo '${{ needs.parse-trigger.outputs.goal }}' | head -1)

          ğŸ¤– Generated by Auto-Dev Bot
          See: #${ISSUE_NUM}"
          else
            COMMIT_MSG="feat: Auto-dev execution

          Goal: $(echo '${{ needs.parse-trigger.outputs.goal }}' | head -1)

          ğŸ¤– Generated by Auto-Dev Bot"
          fi

          git commit -m "$COMMIT_MSG"
          git push origin "${{ steps.setup.outputs.branch_name }}"

  # =========================================================================
  # Job 3: å»ºç«‹ Pull Request
  # =========================================================================
  create-pr:
    name: ğŸ“ Create PR
    needs: [parse-trigger, evolve]
    if: needs.evolve.outputs.has_changes == 'true'
    runs-on: ubuntu-latest

    outputs:
      pr_number: ${{ steps.create-pr.outputs.pr_number }}
      pr_url: ${{ steps.create-pr.outputs.pr_url }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.evolve.outputs.branch_name }}

      - name: Create Pull Request
        id: create-pr
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ needs.parse-trigger.outputs.issue_number || 'null' }};
            const branchName = '${{ needs.evolve.outputs.branch_name }}';
            const goal = `${{ needs.parse-trigger.outputs.goal }}`.substring(0, 200);

            // PR æ¨™é¡Œ
            let title = 'ğŸ¤– Auto-Dev: ';
            if (issueNumber) {
              title += `#${issueNumber} - ${goal.split('\n')[0]}`;
            } else {
              title += goal.split('\n')[0];
            }

            // PR å…§å®¹
            let body = `## ğŸ¤– Auto-Dev Pull Request

            ### ç›®æ¨™
            ${goal}

            ### åŸ·è¡Œæ‘˜è¦
            \`\`\`
            ${{ needs.evolve.outputs.summary }}
            \`\`\`

            ### å¯©æŸ¥æŒ‡å—
            - [ ] ç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥
            - [ ] æ¸¬è©¦è¦†è“‹ç¢ºèª
            - [ ] å®‰å…¨æ€§å¯©æŸ¥
            - [ ] æ–‡æª”æ›´æ–°ç¢ºèª

            ### å¯©æŸ¥å¾Œæ“ä½œ
            - âœ… **åˆä½µ**: ç›´æ¥ merge
            - âœï¸ **éœ€è¦èª¿æ•´**: ç•™è¨€èªªæ˜ï¼Œä½¿ç”¨ \`/evolve [èª¿æ•´èªªæ˜]\` ç¹¼çºŒ
            - â• **ç™¼ç¾æ–°éœ€æ±‚**: å»ºç«‹æ–° Issue ä¸¦åŠ ä¸Š \`auto-dev\` label
            - âŒ **æ‹’çµ•**: Close PR ä¸¦èªªæ˜åŸå› 

            ---
            `;

            if (issueNumber) {
              body += `\nCloses #${issueNumber}`;
            }

            body += `\n\nğŸ¤– Generated by [Auto-Dev Bot]`;

            // å»ºç«‹ PR
            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title.substring(0, 256),
              body: body,
              head: branchName,
              base: 'main',
              draft: false
            });

            console.log(`Created PR #${pr.number}: ${pr.html_url}`);

            // åŠ ä¸Š labels
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              labels: ['ğŸ¤– auto-dev', 'needs-review']
            });

            // å¦‚æœæœ‰å°æ‡‰çš„ Issueï¼ŒåŠ ä¸Šé€£çµ
            if (issueNumber) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: `## âœ… Auto-Dev å®Œæˆï¼

            PR å·²å»ºç«‹ï¼š#${pr.number}

            è«‹å¯©æŸ¥ä¸¦æ±ºå®šï¼š
            - âœ… åˆä½µ PR
            - âœï¸ ç•™è¨€èª¿æ•´ç›®æ¨™
            - âŒ é—œé–‰ä¸¦èªªæ˜åŸå› `
              });
            }

            core.setOutput('pr_number', pr.number);
            core.setOutput('pr_url', pr.html_url);

  # =========================================================================
  # Job 4: é€šçŸ¥ï¼ˆç„¡è®Šæ›´æ™‚ï¼‰
  # =========================================================================
  notify-no-changes:
    name: ğŸ“¢ Notify No Changes
    needs: [parse-trigger, evolve]
    if: needs.evolve.outputs.has_changes == 'false'
    runs-on: ubuntu-latest

    steps:
      - name: Post no-changes notification
        if: needs.parse-trigger.outputs.issue_number
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ needs.parse-trigger.outputs.issue_number }};

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `## âš ï¸ Auto-Dev å®Œæˆä½†ç„¡è®Šæ›´

            åŸ·è¡Œå®Œæˆï¼Œä½†æ²’æœ‰ç”¢ç”Ÿä»»ä½•ç¨‹å¼ç¢¼è®Šæ›´ã€‚

            å¯èƒ½åŸå› ï¼š
            - ç›®æ¨™å·²ç¶“é”æˆ
            - ç›®æ¨™æè¿°ä¸å¤ æ˜ç¢º
            - é‡åˆ°ç„¡æ³•è‡ªå‹•è§£æ±ºçš„å•é¡Œ

            ### åŸ·è¡Œæ‘˜è¦
            \`\`\`
            ${{ needs.evolve.outputs.summary }}
            \`\`\`

            è«‹æª¢æŸ¥ç›®æ¨™æè¿°ä¸¦é‡è©¦ï¼Œæˆ–ä½¿ç”¨ \`/evolve [æ›´æ˜ç¢ºçš„ç›®æ¨™]\` é‡æ–°åŸ·è¡Œã€‚`
            });
