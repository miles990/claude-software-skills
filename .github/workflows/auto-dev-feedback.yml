# ============================================================================
# Auto-Dev Feedback Handler
# ============================================================================
# è™•ç†äººé¡å¯©æŸ¥ feedbackï¼Œæ”¯æ´ï¼š
#   - PR ä¸Šçš„ /evolve å‘½ä»¤ï¼ˆç¹¼çºŒè¿­ä»£ï¼‰
#   - PR merge å¾Œæ›´æ–°è¨˜æ†¶
#   - PR close å¾Œè¨˜éŒ„å¤±æ•—ç¶“é©—
# ============================================================================

name: ğŸ”„ Auto-Dev Feedback

on:
  # PR ä¸Šçš„ comment
  pull_request_review_comment:
    types: [created]

  issue_comment:
    types: [created]

  # PR ç‹€æ…‹è®Šæ›´
  pull_request:
    types: [closed]

env:
  ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

jobs:
  # =========================================================================
  # è™•ç† PR Comment å‘½ä»¤
  # =========================================================================
  handle-pr-command:
    name: ğŸ“ Handle PR Command
    if: |
      github.event_name == 'issue_comment' &&
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '/evolve')
    runs-on: ubuntu-latest

    steps:
      - name: Parse command
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const comment = context.payload.comment.body;
            const evolveMatch = comment.match(/^\/evolve\s+(.+)/s);

            if (evolveMatch) {
              const feedback = evolveMatch[1].trim();
              core.setOutput('feedback', feedback);
              core.setOutput('should_continue', 'true');

              // å–å¾— PR è³‡è¨Š
              const { data: pr } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.payload.issue.number
              });

              core.setOutput('branch_name', pr.head.ref);
              core.setOutput('pr_number', pr.number);
            } else {
              core.setOutput('should_continue', 'false');
            }

      - name: Checkout PR branch
        if: steps.parse.outputs.should_continue == 'true'
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.parse.outputs.branch_name }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Git
        if: steps.parse.outputs.should_continue == 'true'
        run: |
          git config user.name "Auto-Dev Bot"
          git config user.email "auto-dev-bot@users.noreply.github.com"

      - name: Post acknowledgment
        if: steps.parse.outputs.should_continue == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.parse.outputs.pr_number }},
              body: `## ğŸ”„ æ”¶åˆ° Feedbackï¼Œç¹¼çºŒè¿­ä»£ä¸­...

            **èª¿æ•´ç›®æ¨™**:
            > ${{ steps.parse.outputs.feedback }}

            â³ åŸ·è¡Œä¸­...`
            });

      - name: Install Claude Code
        if: steps.parse.outputs.should_continue == 'true'
        run: npm install -g @anthropic-ai/claude-code

      - name: Continue evolution with feedback
        if: steps.parse.outputs.should_continue == 'true'
        env:
          FEEDBACK: ${{ steps.parse.outputs.feedback }}
        run: |
          # åŸ·è¡Œå¸¶æœ‰ feedback çš„ evolve
          claude --dangerously-skip-permissions \
                 --max-turns 30 \
                 "/evolve ç¹¼çºŒæ”¹é€²ï¼Œæ ¹æ“šä»¥ä¸‹ feedback: $FEEDBACK" 2>&1 | tee execution.log

      - name: Commit and push changes
        if: steps.parse.outputs.should_continue == 'true'
        run: |
          git add -A

          if ! git diff --cached --quiet; then
            git commit -m "feat: Iteration based on feedback

          Feedback: $(echo '${{ steps.parse.outputs.feedback }}' | head -1)

          ğŸ¤– Generated by Auto-Dev Bot"
            git push origin ${{ steps.parse.outputs.branch_name }}

            echo "CHANGES_MADE=true" >> $GITHUB_ENV
          else
            echo "CHANGES_MADE=false" >> $GITHUB_ENV
          fi

      - name: Post completion
        if: steps.parse.outputs.should_continue == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const changesMade = '${{ env.CHANGES_MADE }}' === 'true';

            let message = changesMade
              ? `## âœ… è¿­ä»£å®Œæˆï¼

            å·²æ ¹æ“š feedback æ›´æ–°ç¨‹å¼ç¢¼ï¼Œè«‹é‡æ–°å¯©æŸ¥ã€‚`
              : `## âš ï¸ ç„¡æ–°è®Šæ›´

            å·²è™•ç† feedbackï¼Œä½†æ²’æœ‰ç”¢ç”Ÿæ–°çš„ç¨‹å¼ç¢¼è®Šæ›´ã€‚
            å¯èƒ½éœ€è¦æ›´å…·é«”çš„æŒ‡ç¤ºã€‚`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.parse.outputs.pr_number }},
              body: message
            });

  # =========================================================================
  # PR åˆä½µå¾Œï¼šè¨˜éŒ„æˆåŠŸç¶“é©—
  # =========================================================================
  handle-pr-merged:
    name: ğŸ“š Record Success
    if: |
      github.event_name == 'pull_request' &&
      github.event.action == 'closed' &&
      github.event.pull_request.merged == true &&
      contains(github.event.pull_request.labels.*.name, 'ğŸ¤– auto-dev')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Record success to memory
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const pr = context.payload.pull_request;
            const date = new Date().toISOString().split('T')[0];
            const slug = pr.title.toLowerCase()
              .replace(/[^a-z0-9]+/g, '-')
              .substring(0, 50);

            // å»ºç«‹å­¸ç¿’è¨˜éŒ„
            const learningContent = `---
            date: "${date}"
            tags: [auto-dev, success, pr-${pr.number}]
            task: "${pr.title.replace(/"/g, '\\"')}"
            status: resolved
            pr: ${pr.number}
            ---

            # ${pr.title}

            ## æƒ…å¢ƒ
            é€é Auto-Dev è‡ªå‹•å®Œæˆçš„ä»»å‹™

            ## PR æè¿°
            ${pr.body || 'No description'}

            ## çµæœ
            âœ… æˆåŠŸåˆä½µ

            ## è®Šæ›´æª”æ¡ˆ
            ${pr.changed_files} å€‹æª”æ¡ˆ

            ## ç¶“é©—è¨˜éŒ„
            æ­¤ä»»å‹™æˆåŠŸå®Œæˆï¼Œå¯ä½œç‚ºæœªä¾†é¡ä¼¼ä»»å‹™çš„åƒè€ƒã€‚
            `;

            const filePath = `.claude/memory/learnings/${date}-${slug}.md`;

            // ç¢ºä¿ç›®éŒ„å­˜åœ¨
            const dir = '.claude/memory/learnings';
            if (!fs.existsSync(dir)) {
              fs.mkdirSync(dir, { recursive: true });
            }

            fs.writeFileSync(filePath, learningContent);
            console.log(`Created learning record: ${filePath}`);

      - name: Commit memory update
        run: |
          git config user.name "Auto-Dev Bot"
          git config user.email "auto-dev-bot@users.noreply.github.com"

          git add .claude/memory/
          if ! git diff --cached --quiet; then
            git commit -m "docs: Record successful auto-dev experience

          PR: #${{ github.event.pull_request.number }}

          ğŸ¤– Memory updated by Auto-Dev Bot"
            git push
          fi

  # =========================================================================
  # PR é—œé–‰ï¼ˆæœªåˆä½µï¼‰ï¼šè¨˜éŒ„å¤±æ•—ç¶“é©—
  # =========================================================================
  handle-pr-closed:
    name: ğŸ“ Record Failure
    if: |
      github.event_name == 'pull_request' &&
      github.event.action == 'closed' &&
      github.event.pull_request.merged == false &&
      contains(github.event.pull_request.labels.*.name, 'ğŸ¤– auto-dev')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Record failure to memory
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const pr = context.payload.pull_request;
            const date = new Date().toISOString().split('T')[0];
            const slug = pr.title.toLowerCase()
              .replace(/[^a-z0-9]+/g, '-')
              .substring(0, 50);

            // å–å¾— PR comments ä¾†äº†è§£æ‹’çµ•åŸå› 
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number
            });

            const rejectionComments = comments
              .filter(c => !c.user.login.includes('bot'))
              .map(c => `- ${c.user.login}: ${c.body.substring(0, 200)}`)
              .join('\n');

            // å»ºç«‹å¤±æ•—è¨˜éŒ„
            const failureContent = `---
            date: "${date}"
            tags: [auto-dev, failure, pr-${pr.number}]
            task: "${pr.title.replace(/"/g, '\\"')}"
            status: rejected
            pr: ${pr.number}
            ---

            # ${pr.title}

            ## æƒ…å¢ƒ
            é€é Auto-Dev è‡ªå‹•å®Œæˆçš„ä»»å‹™ï¼Œä½† PR è¢«æ‹’çµ•

            ## PR æè¿°
            ${pr.body || 'No description'}

            ## çµæœ
            âŒ PR è¢«é—œé–‰ï¼ˆæœªåˆä½µï¼‰

            ## å¯©æŸ¥è€… Feedback
            ${rejectionComments || 'ç„¡æ˜ç¢º feedback'}

            ## æ•™è¨“
            - éœ€è¦åˆ†æç‚ºä»€éº¼é€™å€‹ä»»å‹™å¤±æ•—
            - æœªä¾†é‡åˆ°é¡ä¼¼ä»»å‹™æ™‚éœ€è¦æ³¨æ„

            ## å¾…æ”¹é€²
            - [ ] åˆ†æå¤±æ•—åŸå› 
            - [ ] æ›´æ–°ç­–ç•¥é¿å…é‡è¹ˆè¦†è½
            `;

            const filePath = `.claude/memory/failures/${date}-${slug}.md`;

            // ç¢ºä¿ç›®éŒ„å­˜åœ¨
            const dir = '.claude/memory/failures';
            if (!fs.existsSync(dir)) {
              fs.mkdirSync(dir, { recursive: true });
            }

            fs.writeFileSync(filePath, failureContent);
            console.log(`Created failure record: ${filePath}`);

      - name: Commit memory update
        run: |
          git config user.name "Auto-Dev Bot"
          git config user.email "auto-dev-bot@users.noreply.github.com"

          git add .claude/memory/
          if ! git diff --cached --quiet; then
            git commit -m "docs: Record failed auto-dev experience

          PR: #${{ github.event.pull_request.number }} (closed without merge)

          ğŸ¤– Memory updated by Auto-Dev Bot"
            git push
          fi
