# ============================================================================
# Auto-Dev Task Queue
# ============================================================================
# ç®¡ç†å¤šå€‹å¾…åŸ·è¡Œçš„ç›®æ¨™ï¼š
#   - æ¯å°æ™‚æª¢æŸ¥å¾…è™•ç†çš„ auto-dev issues
#   - æŒ‰å„ªå…ˆç´šæŽ’åºåŸ·è¡Œ
#   - é¿å…åŒæ™‚åŸ·è¡Œå¤ªå¤šä»»å‹™
# ============================================================================

name: ðŸ“‹ Auto-Dev Queue

on:
  # å®šæ™‚åŸ·è¡Œ
  schedule:
    - cron: '0 * * * *'  # æ¯å°æ™‚åŸ·è¡Œä¸€æ¬¡

  # æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:
    inputs:
      process_count:
        description: 'è™•ç†å¹¾å€‹ä»»å‹™'
        required: false
        type: number
        default: 1

jobs:
  # =========================================================================
  # æª¢æŸ¥ä¸¦è™•ç†ä»»å‹™ä½‡åˆ—
  # =========================================================================
  process-queue:
    name: ðŸ“‹ Process Queue
    runs-on: ubuntu-latest

    steps:
      - name: Check queue and trigger tasks
        uses: actions/github-script@v7
        with:
          script: |
            const processCount = ${{ github.event.inputs.process_count || 1 }};

            // æœå°‹æ‰€æœ‰å¸¶æœ‰ auto-dev label ä½†é‚„æ²’æœ‰å°æ‡‰ PR çš„ issues
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'auto-dev',
              state: 'open',
              sort: 'created',
              direction: 'asc',
              per_page: 20
            });

            console.log(`Found ${issues.length} open auto-dev issues`);

            // éŽæ¿¾å·²ç¶“æœ‰ PR çš„ issues
            const pendingIssues = [];
            for (const issue of issues) {
              // æª¢æŸ¥æ˜¯å¦æœ‰é€£çµçš„ PR
              const { data: events } = await github.rest.issues.listEvents({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number
              });

              const hasLinkedPR = events.some(e =>
                e.event === 'cross-referenced' &&
                e.source?.issue?.pull_request
              );

              // æª¢æŸ¥æ˜¯å¦æœ‰ "processing" label
              const isProcessing = issue.labels.some(l =>
                l.name === 'processing' || l.name === 'â³ processing'
              );

              if (!hasLinkedPR && !isProcessing) {
                pendingIssues.push(issue);
              }
            }

            console.log(`${pendingIssues.length} issues pending processing`);

            // æŒ‰å„ªå…ˆç´šæŽ’åº
            const priorityOrder = { 'priority:high': 0, 'priority:normal': 1, 'priority:low': 2 };
            pendingIssues.sort((a, b) => {
              const aPriority = a.labels.find(l => l.name.startsWith('priority:'))?.name || 'priority:normal';
              const bPriority = b.labels.find(l => l.name.startsWith('priority:'))?.name || 'priority:normal';
              return (priorityOrder[aPriority] || 1) - (priorityOrder[bPriority] || 1);
            });

            // è™•ç†å‰ N å€‹
            const toProcess = pendingIssues.slice(0, processCount);

            for (const issue of toProcess) {
              console.log(`Triggering auto-dev for issue #${issue.number}: ${issue.title}`);

              // åŠ ä¸Š processing label
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: ['â³ processing']
              });

              // è§¸ç™¼ auto-dev workflow
              await github.rest.actions.createWorkflowDispatch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'auto-dev.yml',
                ref: 'main',
                inputs: {
                  goal: `Issue #${issue.number}: ${issue.title}\n\n${issue.body || ''}`,
                  priority: issue.labels.find(l => l.name.startsWith('priority:'))?.name.split(':')[1] || 'normal'
                }
              });
            }

            // è¼¸å‡ºæ‘˜è¦
            const summary = `
            ## ðŸ“‹ Auto-Dev Queue è™•ç†å®Œæˆ

            - ç¸½å¾…è™•ç†: ${pendingIssues.length}
            - æœ¬æ¬¡è™•ç†: ${toProcess.length}
            - å‰©é¤˜å¾…è™•ç†: ${pendingIssues.length - toProcess.length}

            ### æœ¬æ¬¡è™•ç†çš„ Issues
            ${toProcess.map(i => `- #${i.number}: ${i.title}`).join('\n') || 'ç„¡'}

            ### å¾…è™•ç†ä½‡åˆ—
            ${pendingIssues.slice(processCount).map(i => `- #${i.number}: ${i.title}`).join('\n') || 'ç„¡'}
            `;

            console.log(summary);
