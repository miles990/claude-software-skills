#!/bin/bash
# Pre-commit hook for claude-software-skills
# È©óË≠âÊâÄÊúâ SKILL.md Ê™îÊ°àÊ†ºÂºè

set -e

echo "üîç Running pre-commit checks..."

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

ERRORS=0
WARNINGS=0

# ============================================
# Check 1: È©óË≠âÊâÄÊúâ SKILL.md ÁöÑ frontmatter
# ============================================
echo "  ‚úì Validating SKILL.md files..."

SKILL_COUNT=0
for skill in $(find . -name "SKILL.md" -type f -not -path "./.git/*"); do
    SKILL_COUNT=$((SKILL_COUNT + 1))

    # Check frontmatter exists
    if ! head -1 "$skill" | grep -q "^---$"; then
        echo -e "    ${RED}‚ùå Missing frontmatter: $skill${NC}"
        ERRORS=$((ERRORS + 1))
        continue
    fi

    # Check name field
    if ! grep -q "^name:" "$skill"; then
        echo -e "    ${RED}‚ùå Missing 'name' field: $skill${NC}"
        ERRORS=$((ERRORS + 1))
    fi

    # Check description field
    if ! grep -q "^description:" "$skill"; then
        echo -e "    ${YELLOW}‚ö†Ô∏è Missing 'description' field: $skill${NC}"
        WARNINGS=$((WARNINGS + 1))
    fi
done

if [ $ERRORS -eq 0 ]; then
    echo -e "    ${GREEN}‚úÖ All $SKILL_COUNT SKILL.md files valid${NC}"
fi

# ============================================
# Check 2: Ê™¢Êü•ÈáçË§áÁöÑ skill name
# ============================================
echo -n "  ‚úì Checking for duplicate skill names... "

NAMES=$(find . -name "SKILL.md" -type f -not -path "./.git/*" -exec grep -h "^name:" {} \; 2>/dev/null | cut -d: -f2 | tr -d ' ' | sort)
DUPLICATES=$(echo "$NAMES" | uniq -d)

if [ -n "$DUPLICATES" ]; then
    echo -e "${RED}FAILED${NC}"
    echo "    Duplicate names: $DUPLICATES"
    ERRORS=$((ERRORS + 1))
else
    echo -e "${GREEN}OK${NC}"
fi

# ============================================
# Check 3: Ê™¢Êü• README.md
# ============================================
echo -n "  ‚úì Checking README.md exists... "
if [ ! -f "README.md" ]; then
    echo -e "${RED}FAILED${NC}"
    ERRORS=$((ERRORS + 1))
else
    echo -e "${GREEN}OK${NC}"
fi

# ============================================
# Check 4: Ê™¢Êü•Â§ßÊ™îÊ°à (> 1MB)
# ============================================
echo -n "  ‚úì Checking for large files... "
LARGE_FILES=$(find . -type f -size +1M -not -path "./.git/*" 2>/dev/null || true)
if [ -n "$LARGE_FILES" ]; then
    echo -e "${YELLOW}WARNING${NC}"
    echo "    Large files detected (>1MB):"
    echo "$LARGE_FILES" | while read f; do echo "      - $f"; done
    WARNINGS=$((WARNINGS + 1))
else
    echo -e "${GREEN}OK${NC}"
fi

# ============================================
# Summary
# ============================================
echo ""
if [ $ERRORS -gt 0 ]; then
    echo -e "${RED}‚ùå Pre-commit checks failed with $ERRORS error(s)${NC}"
    echo "   Fix the errors above and try again."
    echo "   To skip this check (not recommended): git commit --no-verify"
    exit 1
else
    if [ $WARNINGS -gt 0 ]; then
        echo -e "${YELLOW}‚ö†Ô∏è Pre-commit checks passed with $WARNINGS warning(s)${NC}"
    else
        echo -e "${GREEN}‚úÖ All pre-commit checks passed${NC}"
    fi
    exit 0
fi
